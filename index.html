<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>LanguagePrep Ireland - Spanish</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --primary: #2563eb; 
      --secondary: #db2777; 
      --bg: #f8fafc; 
      --text: #1e293b; 
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
    .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); min-height: 90vh; display: flex; flex-direction: column; }
    
    /* HEADER */
    header { text-align: center; margin-bottom: 20px; }
    h1 { margin: 0; color: var(--primary); font-size: 2.2rem; letter-spacing: -1px; }
    .subtitle { color: var(--secondary); margin-top: 5px; font-size: 0.95rem; font-weight: 700; }
    
    .info-toggle { background: #e0f2fe; color: #0369a1; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-top: 15px; display: inline-flex; align-items: center; gap: 5px; }
    .info-box { display: none; background: #f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: left; font-size: 0.9rem; color: #334155; }

    /* TABS SYSTEM */
    .tabs-container { display: flex; gap: 10px; margin-bottom: 25px; padding: 5px; background: #f1f5f9; border-radius: 15px; }
    .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; transition: 0.2s; color: #64748b; background: transparent; }
    .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

    /* SECTION: CONVERSATION STYLES */
    .level-selector { display: flex; background: #f8fafc; padding: 5px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
    .level-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.3s; font-size: 0.9rem; color: #64748b; background: transparent; }
    .level-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .level-btn.hl.active { color: var(--secondary); }

    .mock-btn { width: 100%; padding: 15px; margin-bottom: 25px; background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3); transition: transform 0.2s; }
    .mock-btn:hover { transform: scale(1.02); }

    .topic-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 25px; }
    .topic-btn { padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; text-align: center; color: #475569; transition: 0.2s; }
    .topic-btn:hover { background: #f1f5f9; }
    .topic-btn.active { border-color: var(--primary); background: #eff6ff; color: var(--primary); transform: scale(1.02); }

    .question-card { background: #fdf2f8; border-left: 5px solid var(--secondary); padding: 25px; border-radius: 0 12px 12px 0; margin-bottom: 20px; }
    
    /* SECTION: ROLEPLAY STYLES */
    .rp-selector { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
    .rp-btn-select { min-width: 130px; padding: 10px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 50px; font-size: 0.85rem; font-weight: 700; cursor: pointer; color: #475569; text-align: center; }
    .rp-btn-select.active { background: var(--primary); color: white; border-color: var(--primary); }
    
    .chat-container { flex-grow: 1; background: #f8fafc; border-radius: 15px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; border: 1px solid #e2e8f0; max-height: 500px; min-height: 300px; margin-bottom: 15px; }
    .bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; }
    .ex { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #334155; border-bottom-left-radius: 4px; }
    .st { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
    .rp-context { font-size: 0.85rem; color: #64748b; margin-bottom: 10px; font-style: italic; text-align: center; }
    
    .rp-controls { display: flex; gap: 10px; border-top: 1px solid #e2e8f0; padding-top: 15px; }
    .rp-input { flex: 1; padding: 12px 20px; border-radius: 50px; border: 2px solid #e2e8f0; background: white; font-size: 1rem; outline: none; }
    .rp-input:focus { border-color: var(--primary); }
    .btn-send { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
    .btn-send:disabled { background: #cbd5e1; }
    
    .next-audio-btn { width: 100%; padding: 12px; background: #ec4899; color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-bottom: 10px; display: none; }
    .feedback-rp { font-size: 0.9em; background: #fffbeb; color: #92400e; padding: 10px; border-radius: 10px; border-left: 4px solid #f59e0b; margin-top: 5px; }
    .model-answer-btn { background: none; border: none; color: #64748b; font-size: 0.8rem; cursor: pointer; text-decoration: underline; display: block; margin: 0 auto; }

    /* SHARED COMPONENTS */
    .audio-btn { margin-top: 15px; background: white; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; color: var(--text); }
    textarea { width: 100%; border: 2px solid #e2e8f0; border-radius: 15px; padding: 15px; min-height: 120px; box-sizing: border-box; font-size: 1rem; margin-bottom: 15px; font-family: inherit; }
    textarea:focus { border-color: var(--secondary); outline: none; }
    .btn-main { width: 100%; padding: 16px; background: var(--text); color: white; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; font-size: 1.1rem; }
    .btn-main:disabled { opacity: 0.5; cursor: wait; }

    /* RESULT & FOOTER */
    #result { margin-top: 30px; display: none; }
    .student-response-box { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #94a3b8; font-style: italic; color: #475569; }
    .feedback-box { padding: 25px; border-radius: 15px; background: #fff; border: 1px solid #e2e8f0; }
    .error-item { margin-bottom: 15px; padding: 15px; background: #fff1f2; border-radius: 10px; border-left: 4px solid #ef4444; }

    .footer-section { margin-top: auto; padding: 40px 20px 20px; border-top: 1px solid #e2e8f0; background: #fafafa; border-radius: 20px; text-align: center; }
    .profile-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); margin-bottom: 15px; }
    .bio-text { max-width: 600px; margin: 0 auto 25px auto; font-size: 0.95rem; line-height: 1.6; color: #475569; text-align: justify; }
    .revolut-btn { background: #000; color: white; text-decoration: none; padding: 14px 28px; border-radius: 50px; font-weight: 700; display: inline-flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: 0.2s; }
    .revolut-btn:hover { transform: translateY(-2px); }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>LanguagePrep Ireland</h1>
    <p class="subtitle">Module: Leaving Cert Spanish (Oral)</p>
    
    <button class="info-toggle" onclick="toggleInfo()">‚ÑπÔ∏è Instructions & Tips</button>
    <div id="infoBox" class="info-box">
      <strong>Instructions / Instrucciones:</strong>
      <ul>
        <li>üó£Ô∏è <strong>General Conversation:</strong> Use the "Conversation" tab to practice topics with AI feedback.</li>
        <li>üé≠ <strong>Roleplays:</strong> Use the "Roleplays" tab to simulate the 5 exam cards.</li>
        <li>‚å®Ô∏è <strong>Keyboard:</strong> Always use the Spanish keyboard on your phone for voice typing.</li>
      </ul>
    </div>
  </header>

  <div class="tabs-container">
    <button class="tab-btn active" onclick="switchTab('conv')" id="tabConv">üí¨ Conversation Topics</button>
    <button class="tab-btn" onclick="switchTab('role')" id="tabRole">üé≠ Roleplays</button>
  </div>

  <div id="sectionConversation">
    <div class="level-selector">
      <button class="level-btn active" id="btnOL" onclick="setLevel('OL')">Ordinary Level</button>
      <button class="level-btn hl" id="btnHL" onclick="setLevel('HL')">Higher Level</button>
    </div>

    <button class="mock-btn" onclick="startMockExam()">üé≤ Start Mock Exam (5 Questions)</button>
    <div class="topic-grid" id="topicGrid"></div>

    <div id="exerciseArea" style="display:none;">
      <div class="question-card">
        <div id="qDisplay" style="font-weight: 700;"></div>
        <button class="audio-btn" onclick="speakText()">üîä Listen</button>
      </div>
      <textarea id="userInput" placeholder="Type or use your microphone..."></textarea>
      <button class="btn-main" id="btnAction" onclick="analyze()">‚ú® Evaluate Answer</button>
    </div>

    <div id="result">
      <div class="student-response-box"><strong>You said:</strong> <span id="userResponseText"></span></div>
      <div class="feedback-box">
        <div id="scoreDisplay" style="font-size: 1.8rem; font-weight: 800; margin-bottom: 15px;"></div>
        <div id="fbES" style="margin-bottom:10px; font-weight:500;"></div>
        <div id="fbEN" style="color:#64748b; font-style:italic;"></div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #e2e8f0;">
        <div id="errorsList"></div>
      </div>
      <button id="btnReset" class="btn-main" style="margin-top:20px; background:#e2e8f0; color:var(--text);" onclick="resetApp()">üîÑ Try another topic</button>
    </div>
  </div>

  <div id="sectionRoleplay" style="display:none;">
    <div class="rp-selector">
      <div class="rp-btn-select" onclick="seleccionarRP(1, this)">üè† 1. Alojamiento</div>
      <div class="rp-btn-select" onclick="seleccionarRP(2, this)">üíª 2. Port√°til</div>
      <div class="rp-btn-select" onclick="seleccionarRP(3, this)">üöê 3. Camper</div>
      <div class="rp-btn-select" onclick="seleccionarRP(4, this)">‚ôªÔ∏è 4. Pl√°sticos</div>
      <div class="rp-btn-select" onclick="seleccionarRP(5, this)">üöó 5. Aver√≠a</div>
    </div>

    <div id="rpArea" style="display:none;">
      <div class="rp-context" id="rpContext"></div>
      <div class="chat-container" id="rpChat"></div>
      
      <button class="next-audio-btn" id="nextAudioBtn" onclick="proximaIntervencion()">üîä Play Examiner Audio</button>
      
      <div class="rp-controls">
        <input type="text" id="rpInput" class="rp-input" placeholder="Select a roleplay above..." disabled>
        <button class="btn-send" id="rpSendBtn" onclick="enviarRespuestaRP()" disabled>‚û§</button>
      </div>
      <button class="model-answer-btn" onclick="mostrarSugerencia()" id="hintBtn" style="display:none; margin-top:10px;">üí° Show Model Answer</button>
    </div>
  </div>

   <div class="footer-section">
    <img src="david.PNG" alt="David Mart√≠n" class="profile-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
    
    <h3 style="margin: 0 0 5px 0;">David Mart√≠n</h3>
    <p style="margin: 0 0 20px 0; font-size: 0.9rem; color: #64748b;">Spanish Teacher at <strong>Ardgillan Community College</strong>.</p>
    
    <div class="bio-text">
      <p><em>As a teacher, my goal is to create innovative tools like <strong>LanguagePrep Ireland</strong> to help students excel in their Leaving Cert exams using technology responsibly and effectively.</em></p>
      <p><em>Mi objetivo es crear recursos innovadores que fomenten un uso responsable y eficiente de la tecnolog√≠a en la preparaci√≥n de los ex√°menes de Leaving Cert.</em></p>
    </div>

    <a href="https://revolut.me/davidkhy4/pocket/TbT6B5Grkq" target="_blank" class="revolut-btn">‚òï Support this Project</a>
    
    <div style="margin-top: 25px; font-size: 0.85rem; line-height: 1.6; color: #475569;">
      <p>All resources are 100% free. If this tool helps you, consider supporting the project.</p>
    </div>

    <div style="margin-top: 35px; border-top: 1px dashed #cbd5e1; padding-top: 25px;">
      <p style="font-size: 0.9rem; font-weight: 700; color: #334155; margin-bottom: 5px;">üí° Anonymous Suggestion Box</p>
      <p style="font-size: 0.75rem; color: #64748b; margin-bottom: 15px;">
        Found a bug? Have an idea? Let me know!<br>
        <span style="color:#ef4444;">Please DO NOT include your name or personal details.</span>
      </p>
      
      <form action="https://formspree.io/f/mjggeygj" method="POST" style="max-width: 450px; margin: 0 auto; text-align: left;">
        
        <textarea name="message" placeholder="Type your suggestion or report a bug here..." required
                  style="width: 100%; padding: 12px; min-height: 80px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #cbd5e1; box-sizing: border-box; font-family: inherit; font-size: 0.9rem;"></textarea>
        
        <button type="submit" 
                style="width: 100%; background: #475569; color: white; border: none; padding: 10px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.9rem;">
          Send Feedback (Anonymous)
        </button>
      </form>
    </div>

  </div>

<script>
// ===========================================
// CONFIGURACI√ìN Y CLAVES (API KEY)
// ===========================================
const parteA = "AIzaSyASf_PIq7es0iPVt"; 
const parteB = "VUMt8Kn1Ll3qSpQQxg"; 
const API_KEY = parteA + parteB;

// --- NAVEGACI√ìN DE PESTA√ëAS ---
function toggleInfo() { const b = document.getElementById('infoBox'); b.style.display = b.style.display === 'block' ? 'none' : 'block'; }

function switchTab(tab) {
  document.getElementById('tabConv').className = tab === 'conv' ? 'tab-btn active' : 'tab-btn';
  document.getElementById('tabRole').className = tab === 'role' ? 'tab-btn active' : 'tab-btn';
  document.getElementById('sectionConversation').style.display = tab === 'conv' ? 'block' : 'none';
  document.getElementById('sectionRoleplay').style.display = tab === 'role' ? 'block' : 'none';
}

// ===========================================
// PARTE 1: CONVERSATION (AI - GEMINI)
// ===========================================
let currentLevel = 'OL';
let currentTopic = null;
let isMockExam = false; 
let mockQuestions = []; // Array para guardar las 5 preguntas del simulacro
let mockIndex = 0;      // Para saber en qu√© pregunta estamos

// Base de datos de Conversaci√≥n (15 Temas)
const DATA = [
  { title: "1. Yo mismo", OL: "¬øC√≥mo te llamas? ¬øCu√°ndo es tu cumplea√±os? ¬øPuedes describirte f√≠sicamente?", HL: "H√°blame de ti. Describe tu personalidad y tu f√≠sico." },
  { title: "2. Mi familia", OL: "¬øCu√°ntas personas hay en tu familia? ¬øTienes hermanos?", HL: "H√°blame de tu familia. ¬øC√≥mo son tus padres y hermanos? ¬øTe llevas bien con ellos?" },
  { title: "3. Mis amigos", OL: "¬øTienes muchos amigos? ¬øC√≥mo se llama tu mejor amigo?", HL: "H√°blame de tu mejor amigo. ¬øTen√©is los mismos intereses? ¬øPor qu√© es especial?" },
  { title: "4. Mi casa", OL: "¬øVives en una casa o en un piso? ¬øC√≥mo es tu dormitorio?", HL: "Describe tu casa ideal. ¬øQu√© es lo que m√°s te gusta y lo que menos de tu hogar?" },
  { title: "5. Mi barrio", OL: "¬øC√≥mo es tu barrio? ¬øHay tiendas o un parque?", HL: "H√°blame de tu barrio. ¬øHay problemas sociales? ¬øQu√© instalaciones hay para j√≥venes?" },
  { title: "6. Mi pueblo/ciudad", OL: "¬øVives en el campo o en la ciudad? ¬øTe gusta tu pueblo?", HL: "H√°blame de tu pueblo o ciudad. ¬øPrefieres la vida urbana o la rural?" },
  { title: "7. Mi colegio", OL: "¬øC√≥mo es tu colegio? ¬øEs mixto? ¬øLlevas uniforme?", HL: "H√°blame de tu instituto. ¬øQu√© opinas de las normas y del uniforme?" },
  { title: "8. Mis asignaturas", OL: "¬øQu√© asignaturas estudias? ¬øCu√°l es tu favorita?", HL: "H√°blame de tus asignaturas. ¬øCrees que el sistema educativo prepara bien para la vida?" },
  { title: "9. Rutina diaria", OL: "¬øA qu√© hora te levantas? ¬øQu√© haces despu√©s del colegio?", HL: "Describe tu rutina diaria. ¬øTe resulta dif√≠cil compaginar el estudio con tu tiempo libre?" },
  { title: "10. Pasatiempos", OL: "¬øQu√© haces en tus ratos libres? ¬øTe gusta el deporte?", HL: "H√°blame de tus aficiones. ¬øPor qu√© es importante tener pasatiempos para la salud mental?" },
  { title: "11. Tareas dom√©sticas", OL: "¬øAyudas en casa? ¬øHaces tu cama?", HL: "H√°blame de las tareas del hogar. ¬øCrees que el reparto es justo en tu casa?" },
  { title: "12. Vacaciones", OL: "¬øQu√© hiciste el verano pasado? ¬øHas estado en Espa√±a?", HL: "H√°blame de tus vacaciones. ¬øPrefieres quedarte en Irlanda o viajar? ¬øPor qu√©?" },
  { title: "13. Planes de Futuro", OL: "¬øQu√© vas a hacer el a√±o que viene? ¬øQuieres ir a la universidad?", HL: "H√°blame de tus planes. ¬øQu√© carrera te gustar√≠a estudiar y por qu√©?" },
  { title: "14. Fin de semana pasado", OL: "¬øQu√© hiciste el fin de semana pasado? ¬øSaliste?", HL: "H√°blame de lo que hiciste el fin de semana pasado. ¬øHiciste algo especial?" },
  { title: "15. Pr√≥ximo fin de semana", OL: "¬øQu√© har√°s el pr√≥ximo fin de semana?", HL: "H√°blame de tus planes para el pr√≥ximo fin de semana." }
];

const PAST_Q = ["¬øQu√© hiciste el fin de semana pasado?", "¬øAd√≥nde fuiste el verano pasado?", "¬øQu√© hiciste ayer?"];
const FUT_Q = ["¬øQu√© har√°s ma√±ana?", "¬øQu√© planes tienes para el verano?", "¬øQu√© har√°s tras el colegio?"];

function setLevel(lvl) { 
    currentLevel = lvl; 
    document.getElementById('btnOL').className = lvl === 'OL' ? 'level-btn active' : 'level-btn'; 
    document.getElementById('btnHL').className = lvl === 'HL' ? 'level-btn hl active' : 'level-btn'; 
    if(currentTopic && !isMockExam) updateQuestion(); 
}

function initConv() { 
    const g = document.getElementById('topicGrid'); 
    DATA.forEach((item) => { 
        const b = document.createElement('button'); 
        b.className = 'topic-btn'; 
        b.innerText = item.title; 
        b.onclick = () => { 
            isMockExam = false; 
            document.querySelectorAll('.topic-btn').forEach(x => x.classList.remove('active')); 
            b.classList.add('active'); 
            currentTopic = item; 
            updateQuestion(); 
        }; 
        g.appendChild(b); 
    }); 
}

function speakText() { 
    // Limpia etiquetas HTML para que no lea "Strong Question..."
    const rawHTML = document.getElementById('qDisplay').innerHTML;
    const t = rawHTML.replace(/<[^>]*>/g, " ").replace(/\(PASADO\)|\(FUTURO\)/g, "").replace(/HL|OL/g, "").replace(/[0-9]\./g, ""); 
    
    if ('speechSynthesis' in window) { 
        window.speechSynthesis.cancel(); 
        const u = new SpeechSynthesisUtterance(t); 
        u.lang = 'es-ES'; 
        u.rate = 0.9; 
        window.speechSynthesis.speak(u); 
    } 
}

// === L√ìGICA DEL MOCK EXAM SECUENCIAL ===

function startMockExam() { 
    isMockExam = true; 
    mockIndex = 0; // Empezamos por la primera
    document.querySelectorAll('.topic-btn').forEach(x => x.classList.remove('active')); 
    
    // Seleccionamos las 5 preguntas
    let i = [...Array(DATA.length).keys()].sort(() => Math.random() - 0.5); 
    mockQuestions = [
        DATA[i[0]][currentLevel],
        DATA[i[1]][currentLevel],
        DATA[i[2]][currentLevel],
        PAST_Q[Math.floor(Math.random()*3)] + " (PASADO)",
        FUT_Q[Math.floor(Math.random()*3)] + " (FUTURO)"
    ];
    
    showMockQuestion();
}

function showMockQuestion() {
    document.getElementById('exerciseArea').style.display = 'block'; 
    document.getElementById('result').style.display = 'none'; 
    // Mostramos solo la pregunta actual con el contador
    document.getElementById('qDisplay').innerHTML = `<strong>Question ${mockIndex + 1}/5:</strong><br><br>${mockQuestions[mockIndex]}`;
    document.getElementById('userInput').value = "";
}

function nextMockQuestion() {
    mockIndex++;
    showMockQuestion();
}

function updateQuestion() { 
    document.getElementById('exerciseArea').style.display = 'block'; 
    document.getElementById('result').style.display = 'none'; 
    document.getElementById('qDisplay').innerHTML = currentTopic[currentLevel]; 
}

function resetApp() { 
    document.getElementById('result').style.display = 'none'; 
    document.getElementById('exerciseArea').style.display = 'block'; 
    if(isMockExam) {
        // Si reseteamos en medio de un mock, salimos del modo mock
        isMockExam = false;
        document.getElementById('userInput').value = "";
        document.getElementById('qDisplay').innerHTML = "Select a topic or start a new Mock Exam.";
    } else {
        document.getElementById('userInput').value = "";
    }
}

async function analyze() {
  const t = document.getElementById('userInput').value; 
  if(t.length < 5) return alert("Por favor, di algo m√°s...");
  
  const b = document.getElementById('btnAction'); 
  b.disabled = true; 
  b.innerText = "‚è≥ Grading...";

  // Determinamos qu√© pregunta estamos evaluando
  const questionContext = isMockExam ? mockQuestions[mockIndex] : currentTopic[currentLevel];

  // üî• PROMPT MEJORADO üî•
  const prompt = `
    ACT AS: Sympathetic Leaving Cert Spanish Oral Examiner (Ireland).
    CONTEXT: The input is RAW VOICE TRANSCRIPTION. It has NO PUNCTUATION and NO CAPITALIZATION.
    
    QUESTION ASKED: "${questionContext}"
    
    CRITICAL INSTRUCTIONS:
    1. IGNORE completely the lack of punctuation.
    2. IGNORE run-on sentences. 
    3. CURRENT LEVEL: ${currentLevel}.
       - If Ordinary Level (OL): Be VERY GENEROUS. If the Spanish is understandable, score HIGH (80-100%).
       - If Higher Level (HL): Look for vocabulary/tenses, but still ignore writing mechanics.
    
    TASK:
    Evaluate the student's answer: "${t}"
    
    OUTPUT JSON ONLY:
    {
      "score": (0-100 based on communication),
      "feedback_es": "Brief motivating feedback in Spanish",
      "feedback_en": "Brief feedback in English",
      "errors": [
        { "original": "error", "correction": "fix", "explanation_en": "reason" }
      ]
    }
  `;

  try {
    const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${API_KEY}`, {
      method: 'POST', 
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    
    const d = await r.json(); 
    const cleanJson = d.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
    const j = JSON.parse(cleanJson);
    
    document.getElementById('exerciseArea').style.display = 'none'; 
    document.getElementById('result').style.display = 'block';
    document.getElementById('userResponseText').innerText = t;
    
    const s = document.getElementById('scoreDisplay');
    s.innerText = `Score: ${j.score}%`;
    s.style.color = j.score >= 85 ? "#166534" : (j.score >= 50 ? "#ca8a04" : "#991b1b");

    document.getElementById('fbES').innerText = "üá™üá∏ " + j.feedback_es; 
    document.getElementById('fbEN').innerText = "üá¨üáß " + j.feedback_en;
    
    const l = document.getElementById('errorsList'); 
    l.innerHTML = "";
    
    if(j.errors && j.errors.length > 0) {
        j.errors.forEach(e => { 
            l.innerHTML += `<div class="error-item"><span style="text-decoration: line-through;">${e.original}</span> ‚û°Ô∏è <b>${e.correction}</b> (üí° ${e.explanation_en})</div>`; 
        });
    } else {
        l.innerHTML = "<div style='color:#166534; font-weight:bold;'>‚úÖ Perfect! No significant errors found.</div>";
    }

    // --- L√ìGICA DEL BOT√ìN SIGUIENTE EN MOCK EXAM ---
    const btnReset = document.getElementById('btnReset');
    if (isMockExam) {
        if (mockIndex < 4) {
            btnReset.innerText = "‚û°Ô∏è Next Question";
            btnReset.onclick = nextMockQuestion; // Asignamos la funci√≥n de siguiente
        } else {
            btnReset.innerText = "üèÅ Finish Exam";
            btnReset.onclick = resetApp; // Al final, reseteamos
        }
    } else {
        btnReset.innerText = "üîÑ Try another topic";
        btnReset.onclick = resetApp;
    }

  } catch (e) { 
    console.error(e);
    alert("Error communicating with AI evaluator. Please try again."); 
  } finally { 
    b.disabled = false; 
    b.innerText = "‚ú® Evaluate Answer"; 
  }
}

// ===========================================
// PARTE 2: ROLEPLAYS (AUDIOS MP3 ORIGINALES)
// ===========================================
let rpActual = null; 
let pasoActual = 0; 
let speaking = false;

// Base de Datos RP (Tus audios)
const RP_DB = {
    1: { context: "ERASMUS in C√°ceres. You call for accommodation.", dialogs: ["¬°Hola, d√≠game!", "¬øEn qu√© parte de la ciudad querr√≠as vivir?", "Entiendo. ¬øPor qu√©?", "Tienes raz√≥n. Pero sabes que C√°ceres es muy peque√±a y se puede andar desde las afueras a la Plaza Mayor en media hora.", ["¬øHas estado antes en Espa√±a?", "¬øQu√© te gusta de Espa√±a?", "¬øPor qu√© estudiar en Espa√±a?"]], sugerencias: ["Voy a ir de Erasmus a la universidad durante el pr√≥ximo curso acad√©mico. No conozco a nadie en C√°ceres. ¬øPodr√≠a darme alg√∫n consejo para encontrar alojamiento por favor?", "Preferir√≠a vivir cerca de la universidad porque el a√±o pasado viv√≠ en las afueras de Dubl√≠n y no me gust√≥.", "Pues es que pasaba demasiado tiempo viajando porque estaba muy lejos de todo. Si pudiera dedicar ese tiempo a estudiar, podr√≠a sacar buenas notas.", "Eso no est√° tan lejos y el clima es mucho mejor que en Irlanda as√≠ que tendr√© en cuenta todos los barrios aunque preferir√≠a vivir en el centro de la ciudad.", "(Respuesta libre)"] },
    2: { context: "Broken laptop in √Åvila. Repair shop.", dialogs: ["¬°Hola! ¬øEn qu√© puedo ayudarte?", "Vamos a ver. ¬øQu√© te pas√≥?", "Vas a necesitar una pantalla nueva que cuesta 200 euros.", "S√≠, hay una oferta especial esta semana. ¬øQuieres comprarlo?", ["¬øDe qu√© marca es tu ordenador?","¬øPara qu√© usas el ordenador?","¬øDe qu√© color te gustar√≠a la funda?"]], sugerencias: ["Se me cay√≥ el port√°til y la pantalla est√° rota. Lo peor es que tengo que entregar un ensayo ma√±ana y la √∫nica copia que tengo est√° en mi port√°til.", "Llegaba tarde y tuve que correr para coger el autob√∫s. Me resbal√© y el port√°til se cay√≥ al suelo y me di cuenta del problema en cuanto me levant√©.", "Es bueno saber que tiene arreglo pero he visto un port√°til del mismo modelo y la misma marca a la venta en el escaparate y solo cuesta trescientos euros.", "Lo comprar√© si me copias los archivos y me das una funda gratis.", "(Respuesta libre)"] },
    3: { context: "Hiring a camper van. Family holiday.", dialogs: ["¬°Hola! ¬øEn qu√© puedo ayudarte?", "Para alquilar un c√°mper hace falta tener al menos veinticinco a√±os y mucha experiencia al volante.", "Pues, muy bien. Tu madre cumple con los requisitos para alquilar un c√°mper.", "¬°Fenomenal! Os alquilo un c√°mper. ¬øTen√©is el itinerario previsto?", ["¬øA qu√© hora vendr√©is a recogerla?", "¬øQu√© m√∫sica os gusta?", "¬øQu√© ciudades quer√©is visitar?"]], sugerencias: ["Soy estudiante y llamo desde Irlanda, me interesa alquilar un c√°mper durante dos semanas en julio.", "Mi madre va a conducir porque yo todav√≠a no tengo el carn√© de conducir. Estoy yendo a clases de conducir y espero aprobar el examen en oto√±o.", "Ha conducido por la derecha en varios pa√≠ses europeos durante los √∫ltimos veinte a√±os. Es una conductora muy prudente y nunca ha tenido un accidente.", "Hemos pasado mucho tiempo en la costa, pero este verano nos gustar√≠a viajar por Castilla-La Mancha para ver la tierra de Cervantes y Don Quijote, lejos de los turistas.", "(Respuesta libre)"] },
    4: { context: "Discussion: Single-use plastics.", dialogs: ["Pareces muy contento, ¬øpor qu√©?", "¬øEs importante prohibir pl√°sticos de usar y tirar?", "¬øPodemos hacer algo m√°s?", "Y, ¬øya est√°?", ["¬øQu√© reciclas en casa?", "¬øQu√© haces t√∫ por el planeta?", "¬øC√≥mo vienes al instituto?"]], sugerencias: ["El Parlamento Europeo ha convenido prohibir los pl√°sticos de un solo uso, por ejemplo, los cuchillos, los tenedores, las cucharas, las tazas, los platos y las pajitas.", "S√≠, es absolutamente imprescindible. Ser√° muy bueno para las aguas del planeta. La contaminaci√≥n causada por los pl√°sticos es un problema grave en r√≠os, lagos y oc√©anos.", "Hay muchas cosas que podemos hacer. por ejemplo, en vez de usar pl√°sticos, podemos usar papel reciclado, cart√≥n y otros materiales biodegradables.", "No, como ciudadanos necesitamos ser m√°s responsables y cambiar nuestro estilo de vida. Para proteger el medio ambiente podr√≠amos ir en bicicleta, usar el transporte p√∫blico o caminar m√°s a menudo.", "(Respuesta libre)"] },
    5: { context: "Car breakdown on AP-6.", dialogs: ["Hola, buenas tardes.", "Debes estar entre Medina del Campo y Tordesillas. ¬øHay alguna se√±al de tr√°fico por ah√≠?", "Claro que s√≠. Voy a arreglarlo todo inmediatamente.", "Por supuesto. ¬øMe puedes describir tu coche?", ["¬øViajas solo o acompa√±ado?", "¬øQu√© ciudades quieres visitar?", "¬øCu√°nto cost√≥ el coche?"]], sugerencias: ["Mi coche se ha averiado en la AP-6. No s√© donde estoy pero pas√© el peaje hace media hora.", "Veo a lo lejos la se√±al de salida 156. ¬øPueden enviar un mec√°nico o quiz√°s una gr√∫a? Es que creo que el problema es serio", "¬øPodr√≠an darme un coche de sustituci√≥n para que pueda seguir mi viaje a Lugo. Tengo que recoger a mis padres en el aeropuerto de Santiago de Compostela.?", "Es un Seat Ibiza rojo, matr√≠cula 4620 CFK. Se lo compr√© de segunda mano a mi t√≠a y nunca antes he tenido un problema con √©l.", "(Respuesta libre)"] }
};

function seleccionarRP(id, btn) {
    rpActual = id; pasoActual = 0; speaking = false;
    document.querySelectorAll('.rp-btn-select').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('rpArea').style.display = "block";
    document.getElementById('rpContext').innerHTML = "Situation: " + RP_DB[id].context;
    document.getElementById('rpChat').innerHTML = `<div class="bubble ex"><b>System:</b> Press "Play Examiner Audio" to start.</div>`;
    document.getElementById('nextAudioBtn').style.display = "block";
    document.getElementById('rpInput').disabled = true; document.getElementById('rpSendBtn').disabled = true;
    document.getElementById('hintBtn').style.display = "none";
}

function reproducirAudio(path, fallbackText) {
    const audio = new Audio(path);
    // Si el audio falla (ej: archivo no subido), usa Voz Rob√≥tica de reserva
    audio.onerror = () => {
        console.log("Audio no encontrado, usando TTS de reserva: " + path);
        const u = new SpeechSynthesisUtterance(fallbackText);
        u.lang = 'es-ES';
        u.onend = habilitarInput;
        window.speechSynthesis.speak(u);
    };
    audio.onended = habilitarInput;
    audio.play().catch(e => { console.log("Error play:", e); audio.onerror(); });
}

function habilitarInput() {
    speaking = false;
    if(pasoActual < RP_DB[rpActual].dialogs.length) { 
        document.getElementById('rpInput').disabled = false;
        document.getElementById('rpSendBtn').disabled = false;
        document.getElementById('rpInput').focus();
        document.getElementById('hintBtn').style.display = "block";
        document.getElementById('rpInput').placeholder = "Type your reply...";
    }
}

function proximaIntervencion() {
    if (!rpActual || speaking) return;
    document.getElementById('nextAudioBtn').style.display = "none";
    speaking = true;
    
    if (pasoActual >= 5) {
        document.getElementById('rpChat').innerHTML += `<div class="bubble ex" style="background:#dcfce7; border-color:#86efac;"><b>System:</b> Roleplay Completed! Well done.</div>`;
        return;
    }

    let dialogText = RP_DB[rpActual].dialogs[pasoActual];
    let audioFile = "";

    if (Array.isArray(dialogText)) {
        const randomIndex = Math.floor(Math.random() * dialogText.length);
        dialogText = dialogText[randomIndex];
        const letter = ['a','b','c'][randomIndex]; 
        audioFile = `rp${rpActual}_5${letter}.mp3`;
    } else {
        audioFile = `rp${rpActual}_${pasoActual + 1}.mp3`;
    }

    const chat = document.getElementById('rpChat');
    chat.innerHTML += `<div class="bubble ex"><b>Examiner:</b> ${dialogText}</div>`;
    chat.scrollTop = chat.scrollHeight;
    reproducirAudio(audioFile, dialogText);
}

function enviarRespuestaRP() {
    const inp = document.getElementById('rpInput');
    const txt = inp.value.trim(); if(!txt) return;
    const chat = document.getElementById('rpChat');
    chat.innerHTML += `<div class="bubble st">${txt}</div>`;
    chat.scrollTop = chat.scrollHeight;
    inp.value = ""; inp.disabled = true; document.getElementById('rpSendBtn').disabled = true;
    document.getElementById('hintBtn').style.display = "none";
    pasoActual++;
    setTimeout(() => { 
        if(pasoActual < 5) { document.getElementById('nextAudioBtn').style.display = "block"; } else { document.getElementById('rpChat').innerHTML += `<div class="bubble ex" style="background:#dcfce7;"><b>System:</b> Roleplay Completed!</div>`; }
    }, 500);
}

function mostrarSugerencia() {
    const sug = RP_DB[rpActual].sugerencias[pasoActual];
    if(sug) {
        const chat = document.getElementById('rpChat');
        chat.innerHTML += `<div class="feedback-rp">üí° <b>Model Answer:</b> ${sug}</div>`;
        chat.scrollTop = chat.scrollHeight;
    }
}

initConv();
</script>
  <script data-goatcounter="https://lcoralprep.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
